# =====================================================================
# Splunk OpenTelemetry Collector - values.yaml
# Includes:
#   - Host + K8s metrics
#   - Prometheus autodiscovery via annotations (works w/ KubeInvaders)
#   - Lightweight resources for small AKS clusters
#   - Logs + events ingestion
# =====================================================================

clusterName: "kubeinvaders"

# ==========================
# AGENT (DaemonSet)
# ==========================
agent:
  enabled: true

  # Fit small AKS nodes
  resources:
    requests:
      cpu: 100m
      memory: 200Mi
    limits:
      cpu: 200m
      memory: 300Mi

  # Allow scheduling in tainted nodes if necessary
  nodeSelector: {}
  tolerations:
    - operator: "Exists"

  # --- Core Collector Configuration ---
  config:
    receivers:
      hostmetrics:
        scrapers:
          cpu: {}
          memory: {}
          load: {}
          filesystem: {}
          network: {}

      # Prometheus auto-discovery for workloads using scrape annotations
      prometheus:
        config:
          scrape_configs:
            - job_name: "kubernetes-pods"
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                # Keep only annotated pods with prometheus.io/scrape = true
                - action: keep
                  source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                  regex: true
                - action: replace
                  source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                  target_label: __metrics_path__
                  regex: (.+)
                - action: replace
                  source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                  regex: (.+):(?:\d+);(\d+)
                  replacement: $1:$2
                  target_label: __address__

    processors:
      batch: {}

    exporters:
      otlp:
        endpoint: "ingest.<your-realm>.signalfx.com:443"
        headers:
          x-sf-token: "${SPLUNK_OBSERVABILITY_ACCESS_TOKEN}"

    service:
      pipelines:
        metrics:
          receivers: [hostmetrics, prometheus]
          processors: [batch]
          exporters: [otlp]

# No gateway needed for lab environments
gateway:
  enabled: false

# ==========================
# Logs & Events
# ==========================
logsEnabled: true
logsEngine: otlp
k8sEventsEnabled: true
k8sMetricsEnabled: true

# ==========================
# Splunk Observability Config
# ==========================
splunkObservability:
  realm: "au0"
  accessToken: "${SPLUNK_OBSERVABILITY_ACCESS_TOKEN}"

# Optional: send logs to Splunk Enterprise / Splunk Cloud HEC
splunkPlatform:
  hec:
    enabled: false
    token: "${SPLUNK_PLATFORM_HEC_TOKEN}"
    host: "<splunk-hec-hostname>"
    port: 8088
    index: "k8s"
    insecureSkipVerify: true
